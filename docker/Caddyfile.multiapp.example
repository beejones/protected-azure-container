# Example: Shared Caddy for a multi-app Ubuntu server
#
# Pattern:
# - Run ONE Caddy instance bound to 80/443 on the host.
# - Each app stack joins the same external Docker network (see docker/docker-compose.shared-caddy.yml).
# - Caddy reverse-proxies to each app container by container name.
#
# You will typically mount this file into a separate "shared caddy" stack.

{$ACME_EMAIL:?required}

protected.example.com {
    tls {$ACME_EMAIL}
    header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    basicauth /* {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
    }

    reverse_proxy protected-container:8080 {
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
}

# Add additional hostnames pointing at other stacks on the same Docker network.
# other.example.com {
#     tls {$ACME_EMAIL}
#     reverse_proxy other-app:8080
# }

:80 {
    respond /healthz "OK" 200
}
